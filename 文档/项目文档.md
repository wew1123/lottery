# 抽奖系统项目文档

## 一、项目概述

这是一个基于Go语言开发的抽奖系统，采用了分层架构设计，包含用户认证、抽奖逻辑、奖品管理、黑名单控制等核心功能。

## 二、项目结构

```
lottery_single/
├── cmd/
│   └── main.go              # 项目入口
├── configs/
│   ├── config.go            # 配置加载
│   └── config.yml           # 配置文件
├── internal/
│   ├── handlers/            # HTTP请求处理层
│   │   ├── params/          # 请求参数定义
│   │   ├── lotteryv1.go     # 抽奖接口v1版本
│   │   ├── lotteryv2.go     # 抽奖接口v2版本
│   │   ├── lotteryv3.go     # 抽奖接口v3版本
│   │   └── prizeadd.go      # 奖品添加接口
│   ├── model/               # 数据模型定义
│   ├── pkg/
│   │   ├── constant/        # 常量定义
│   │   ├── middlewares/     # 中间件（缓存、数据库、锁、日志）
│   │   ├── task/            # 定时任务
│   │   └── utils/           # 工具函数
│   ├── repo/                # 数据访问层
│   ├── service/             # 业务逻辑层
│   └── utils/               # 通用工具
├── router/                   # 路由配置
├── sql/                     # 数据库脚本
└── go.mod                   # 依赖管理
```

## 三、核心组件分析

### 1. 配置系统

配置文件`configs/config.yml`包含了应用、数据库、日志和Redis的配置信息。`configs/config.go`负责加载和解析这些配置。

### 2. 数据库设计

主要数据表：
- `t_prize`：奖品表，存储奖品信息、数量、中奖概率等
- `t_coupon`：优惠券表，存储优惠券编码
- `t_result`：抽奖记录表，记录用户抽奖结果
- `t_black_user`：用户黑名单表
- `t_black_ip`：IP黑名单表
- `t_lottery_times`：用户每日抽奖次数表
- `t_user`：用户表

### 3. 抽奖逻辑

#### 核心流程：
1. 用户认证（JWT token解析）
2. 分布式锁防止重复抽奖
3. 验证用户今日抽奖次数
4. 验证IP抽奖次数限制
5. 生成随机抽奖码
6. 根据抽奖码匹配奖品
7. 发放奖品
8. 记录抽奖结果

#### 版本差异：
- **v1**：基础版本，直接操作数据库
- **v2**：引入缓存优化性能
- **v3**：增加奖品池机制，优化并发处理

### 4. 关键服务

#### LotteryService
主要方法：
- `GetPrize`：根据抽奖码获取奖品
- `GetAllUsefulPrizes`：获取所有可用奖品
- `GiveOutPrize`：发放奖品
- `PrizeLargeBlackLimit`：实物奖品黑名单限制

#### LimitService
主要负责抽奖次数限制：
- `CheckUserDayLotteryTimes`：检查用户每日抽奖次数
- `CheckIPLimit`：检查IP抽奖次数

### 5. 定时任务

- `DoResetIPLotteryNumsTask`：重置IP抽奖次数
- `DoResetUserLotteryNumsTask`：重置用户抽奖次数
- `DoPrizePlanTask`：执行奖品发放计划

## 四、技术栈

- **语言**：Go 1.18+
- **框架**：Gin Web框架
- **数据库**：MySQL + GORM ORM
- **缓存**：Redis
- **认证**：JWT
- **日志**：自定义日志系统
- **锁**：Redis分布式锁

## 五、运行流程

1. 初始化配置
2. 初始化日志、数据库、Redis连接
3. 初始化服务层
4. 启动定时任务
5. 初始化路由并启动HTTP服务

## 六、核心业务逻辑

### 抽奖算法

系统采用区间匹配算法：
- 每个奖品定义中奖编码区间（如"1-100"表示1%中奖概率）
- 生成0-9999的随机数
- 匹配随机数所在的奖品区间
- 发放对应奖品

### 并发控制

- 分布式锁防止同一用户重复抽奖
- Redis缓存优化数据库访问
- 奖品池机制控制并发发放

### 安全机制

- JWT token认证
- 用户和IP黑名单
- 抽奖次数限制
- 防重入机制

## 七、扩展点

1. **奖品类型扩展**：支持虚拟币、优惠券、实物奖品
2. **抽奖策略扩展**：可自定义不同的抽奖算法
3. **缓存策略扩展**：可配置不同的缓存过期时间
4. **监控扩展**：可添加性能监控和日志分析

## 八、部署说明

1. 配置数据库连接信息
2. 导入sql/lottery.sql脚本
3. 配置Redis连接信息
4. 运行`go run cmd/main.go`启动服务
5. 访问http://localhost:8081进行测试